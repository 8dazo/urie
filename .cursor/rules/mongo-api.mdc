---
description: API and MongoDB conventions for Urie backend
globs: "**/api/**/*.ts,**/backend/**/*.ts,**/models/**/*.ts,**/migrations/**/*.ts"
alwaysApply: false
---

# API & MongoDB

- **Schema:** Define documents in code (TypeScript interfaces + Mongoose or Zod). Use constants for field names to ease renames.
- **Tenant model:** Queries should be scoped by `agencyId` (or equivalent) unless explicitly system-wide.
- **Migrations:** In `backend/migrations/` (or equivalent). Scripts must be idempotent; record completed migration IDs in DB; for large collections, migrate in batches (e.g. by `agencyId` or `_id`).
- **Indexes:** Create in background where supported; document new indexes when adding queries.
- **Secrets:** Never commit tokens or API keys; use env vars and encrypt stored OAuth tokens.
