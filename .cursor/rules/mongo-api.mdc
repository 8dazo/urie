---
description: API and Prisma/MongoDB conventions for Urie backend
globs: "**/api/**/*.ts,**/lib/**/*.ts,**/prisma/**/*.ts"
alwaysApply: false
---

# API & Prisma + MongoDB

- **Schema:** Prisma schema in `prisma/schema.prisma` is the single source of truth. Use `prisma` from `@/lib/prisma`; use generated types. Use constants for field names in app code when referencing often-renamed fields.
- **Tenant model:** Queries should be scoped by `agencyId` (or equivalent) unless explicitly system-wide.
- **Schema changes:** Update `prisma/schema.prisma`, then `npx prisma db push` (MongoDB); run on staging first. Prefer additive changes.
- **Indexes:** Add `@@index` in schema as needed; document new indexes when adding queries.
- **Secrets:** Never commit tokens or API keys; use env vars and encrypt stored OAuth tokens.
